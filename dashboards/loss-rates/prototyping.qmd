```{r}
library(dplyr)

losses_df <- readr::read_rds(
  file.path(
    here::here(), "dashboards", "loss-rates", "data", "mod_losses.rds"
    )
  )

losses_df
```


```{r}
losses_df$reverse_week_numbers <- 
  losses_df |>
  pull(day) |> 
  (\(x) x / 7)() |>
  ceiling() |>
  as.integer() |>
  rev()

losses_df$week_numbers <- 
  losses_df |>
  pull(day) |> 
  (\(x) x / 7)() |>
  ceiling() |>
  as.integer()

losses_df <-
  losses_df |> 
  group_by(reverse_week_numbers) |> 
  mutate(reverse_week_start_date = min(date)) |> 
  ungroup() |> 
  group_by(week_numbers) |> 
  mutate(week_start_date = min(date)) |> 
  ungroup()

  
reverse_weekly_losses_summary <-
  losses_df |> 
  group_by(reverse_week_start_date) |> 
  summarise(across(-ends_with("diff"), max)) |> 
  filter(reverse_week_start_date == max(reverse_week_start_date)) |> 
  tidyr::pivot_longer(
    cols = -c("date", "day", "reverse_week_numbers", "reverse_week_start_date", "week_start_date", "week_numbers"),
    names_to = "loss_type", values_to = "total_loss"
  )

reverse_weekly_losses_summary <-
  reverse_weekly_losses_summary |> 
  left_join(
    losses_df |> 
    group_by(reverse_week_start_date) |> 
    summarise(across(ends_with("diff"), sum)) |> 
    filter(reverse_week_start_date == max(reverse_week_start_date)) |> 
    rename_with(\(x) gsub("_diff", "", x, fixed = TRUE)) |> 
    tidyr::pivot_longer(
      cols = -c("reverse_week_start_date"),
      names_to = "loss_type", values_to = "weekly_loss"
    ),
    by = c("reverse_week_start_date", "loss_type")
  ) |> 
  select(reverse_week_start_date, date, loss_type, total_loss, weekly_loss)
  
reverse_weekly_losses_summary
```



